<!DOCTYPE html>
<html>
<head>
    <title>WebSocket è¿æ¥æµ‹è¯•</title>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
</head>
<body>
    <h1>WebSocket è¿æ¥æµ‹è¯•</h1>
    <div id="status">çŠ¶æ€: æœªè¿æ¥</div>
    <button onclick="connect()">è¿æ¥</button>
    <button onclick="disconnect()">æ–­å¼€</button>
    <div id="log" style="margin-top: 20px; border: 1px solid #ccc; padding: 10px; max-height: 400px; overflow-y: auto;"></div>

    <script>
        let stompClient = null;

        function log(message) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${time}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function connect() {
            const socket = new WebSocket('ws://10.0.2.2:8080/ws');
            stompClient = new StompJs.Client({
                webSocketFactory: () => socket,
                connectHeaders: {},
                debug: (str) => {
                    log('DEBUG: ' + str);
                },
                reconnectDelay: 5000,
                heartbeatIncoming: 4000,
                heartbeatOutgoing: 4000
            });

            stompClient.onConnect = (frame) => {
                log('âœ… è¿æ¥æˆåŠŸ!');
                document.getElementById('status').innerText = 'çŠ¶æ€: å·²è¿æ¥';
                
                // è®¢é˜…æ¶ˆæ¯
                stompClient.subscribe('/queue/messages/test-user', (message) => {
                    log('ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ' + message.body);
                });
                
                log('ğŸ“¡ å·²è®¢é˜… /queue/messages/test-user');
            };

            stompClient.onStompError = (frame) => {
                log('âŒ STOMPé”™è¯¯: ' + frame.headers['message']);
                log('è¯¦ç»†ä¿¡æ¯: ' + frame.body);
            };

            stompClient.onWebSocketClose = (event) => {
                log('ğŸ”Œ WebSocketè¿æ¥å…³é—­');
                document.getElementById('status').innerText = 'çŠ¶æ€: å·²æ–­å¼€';
            };

            stompClient.onWebSocketError = (event) => {
                log('âŒ WebSocketé”™è¯¯');
            };

            log('ğŸ”Œ å¼€å§‹è¿æ¥åˆ° ws://10.0.2.2:8080/ws ...');
            stompClient.activate();
        }

        function disconnect() {
            if (stompClient !== null) {
                stompClient.deactivate();
                log('æ–­å¼€è¿æ¥');
                document.getElementById('status').innerText = 'çŠ¶æ€: å·²æ–­å¼€';
            }
        }

        // é¡µé¢åŠ è½½åè‡ªåŠ¨è¿æ¥
        window.onload = () => {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡æµ‹è¯•è¿æ¥');
        };
    </script>
</body>
</html>
